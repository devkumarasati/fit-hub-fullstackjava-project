<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer Dashboard - FitPlanHub</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>ðŸ’ª FitPlanHub</h1>
            </div>
            <div class="nav-links">
                <a href="../index.html">Home</a>
                <a href="trainer-dashboard.html">Dashboard</a>
                <span id="userGreeting"></span>
                <button id="logoutBtn">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container dashboard">
        <h2>Trainer Dashboard</h2>

        <div class="dashboard-actions">
            <button class="btn btn-primary" onclick="showCreateForm()">
                + Create New Plan
            </button>
        </div>


        <div id="planForm"
            style="display: none; background: white; padding: 30px; border-radius: 10px; margin-bottom: 30px;">
            <h3 id="formTitle">Create New Plan</h3>
            <div id="formError" class="error-message" style="display: none;"></div>

            <form id="planEditForm">
                <input type="hidden" id="editPlanId">

                <div class="form-group">
                    <label for="title">Plan Title:</label>
                    <input type="text" id="title" required>
                </div>

                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description" required></textarea>
                </div>

                <div class="form-group">
                    <label for="price">Price (â‚¹):</label>
                    <input type="number" id="price" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="durationDays">Duration (days):</label>
                    <input type="number" id="durationDays" required>
                </div>

                <button type="submit" class="btn btn-success">Save Plan</button>
                <button type="button" class="btn btn-secondary" onclick="hideForm()">Cancel</button>
            </form>
        </div>


        <div>
            <h3>My Fitness Plans</h3>
            <div id="myPlansContainer" class="plans-grid">
                <div class="loading">Loading your plans...</div>
            </div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script>

        if (!requireLogin() || !requireRole('TRAINER')) {

        }

        document.addEventListener('DOMContentLoaded', function () {
            loadMyPlans();
        });


        async function loadMyPlans() {
            const container = document.getElementById('myPlansContainer');

            try {
                const response = await makeAuthenticatedRequest(API_ENDPOINTS.GET_MY_PLANS);
                const data = await response.json();

                if (data.success && data.plans) {
                    displayMyPlans(data.plans);
                } else {
                    container.innerHTML = '<p>You haven\'t created any plans yet.</p>';
                }
            } catch (error) {
                console.error('Error loading plans:', error);
                container.innerHTML = '<p>Error loading plans.</p>';
            }
        }


        function displayMyPlans(plans) {
            const container = document.getElementById('myPlansContainer');
            container.innerHTML = '';

            if (plans.length === 0) {
                container.innerHTML = '<p>You haven\'t created any plans yet.</p>';
                return;
            }

            plans.forEach(plan => {
                const card = document.createElement('div');
                card.className = 'plan-card';
                card.innerHTML = `
                    <h3>${plan.title}</h3>
                    <p class="plan-description">${plan.description}</p>
                    <p class="plan-price">â‚¹${plan.price}</p>
                    <p class="plan-duration">${plan.durationDays} days</p>
                    <button class="btn btn-secondary" onclick="editPlan(${plan.planId})">Edit</button>
                    <button class="btn btn-danger" onclick="deletePlan(${plan.planId})">Delete</button>
                `;
                container.appendChild(card);
            });
        }


        function showCreateForm() {
            document.getElementById('formTitle').textContent = 'Create New Plan';
            document.getElementById('planEditForm').reset();
            document.getElementById('editPlanId').value = '';
            document.getElementById('planForm').style.display = 'block';
        }


        function hideForm() {
            document.getElementById('planForm').style.display = 'none';
            document.getElementById('formError').style.display = 'none';
        }


        async function editPlan(planId) {
            try {
                const response = await makeAuthenticatedRequest(
                    `${API_ENDPOINTS.GET_PLAN_BY_ID}&planId=${planId}`
                );
                const data = await response.json();

                if (data.success && data.plan) {
                    const plan = data.plan;
                    document.getElementById('formTitle').textContent = 'Edit Plan';
                    document.getElementById('editPlanId').value = plan.planId;
                    document.getElementById('title').value = plan.title;
                    document.getElementById('description').value = plan.description;
                    document.getElementById('price').value = plan.price;
                    document.getElementById('durationDays').value = plan.durationDays;
                    document.getElementById('planForm').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading plan:', error);
                alert('Error loading plan details');
            }
        }


        async function deletePlan(planId) {
            if (!confirm('Are you sure you want to delete this plan?')) {
                return;
            }

            try {
                const response = await makeAuthenticatedRequest(
                    `${API_ENDPOINTS.DELETE_PLAN}?planId=${planId}`,
                    { method: 'DELETE' }
                );

                const data = await response.json();

                if (data.success) {
                    alert('Plan deleted successfully');
                    loadMyPlans();
                } else {
                    alert(data.message || 'Failed to delete plan');
                }
            } catch (error) {
                console.error('Error deleting plan:', error);
                alert('Error deleting plan');
            }
        }


        document.getElementById('planEditForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const planId = document.getElementById('editPlanId').value;
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const price = parseFloat(document.getElementById('price').value);
            const durationDays = parseInt(document.getElementById('durationDays').value);

            const errorDiv = document.getElementById('formError');
            errorDiv.style.display = 'none';

            try {
                let response;
                if (planId) {

                    response = await makeAuthenticatedRequest(API_ENDPOINTS.UPDATE_PLAN, {
                        method: 'PUT',
                        body: JSON.stringify({ planId, title, description, price, durationDays })
                    });
                } else {

                    response = await makeAuthenticatedRequest(API_ENDPOINTS.CREATE_PLAN, {
                        method: 'POST',
                        body: JSON.stringify({ title, description, price, durationDays })
                    });
                }

                const data = await response.json();

                if (data.success) {
                    alert(planId ? 'Plan updated successfully' : 'Plan created successfully');
                    hideForm();
                    loadMyPlans();
                } else {
                    errorDiv.textContent = data.message;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error saving plan:', error);
                errorDiv.textContent = 'Error saving plan';
                errorDiv.style.display = 'block';
            }
        });
    </script>
</body>

</html>